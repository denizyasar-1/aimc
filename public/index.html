<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multiplayer PvP Oyun</title>
<style>
    html, body { height: 100%; margin: 0; overflow: hidden; background: #111; }
    #ui { position: fixed; inset: 0 auto auto 0; color: #fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; pointer-events: none; }
    .panel { position: absolute; left: 16px; top: 16px; background: rgba(0,0,0,.55); padding: 12px 14px; border-radius: 14px; backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,.08); pointer-events: auto; }
    .panel h1 { font-size: 14px; margin: 0 0 8px; letter-spacing: .3px; font-weight: 700; }
    .panel p { margin: 4px 0; font-size: 12px; line-height: 1.45; opacity: .95; }
    .hotbar { position: absolute; left: 50%; bottom: 18px; transform: translateX(-50%); display: grid; grid-auto-flow: column; gap: 8px; }
    .slot { width: 46px; height: 46px; border-radius: 10px; border: 1px solid rgba(255,255,255,.15); background: rgba(0,0,0,.35); display: grid; place-content: center; color: #fff; font-weight: 700; }
    .slot.active { outline: 2px solid #fff; outline-offset: 2px; }
    .crosshair { position: absolute; left: 50%; top: 50%; width: 14px; height: 14px; transform: translate(-50%, -50%); }
    .crosshair::before, .crosshair::after { content: ""; position: absolute; background: #fff; opacity: .8; }
    .crosshair::before { left: 6px; top: 0; width: 2px; height: 14px; }
    .crosshair::after { top: 6px; left: 0; height: 2px; width: 14px; }
    .hint { position: absolute; right: 16px; bottom: 16px; color: #9ae6b4; font-size: 12px; background: rgba(0,0,0,.4); padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,.08); }
    canvas { display: block; }
    .badge { display:inline-block; padding:2px 6px; border-radius:6px; background:#2d3748; font-size:11px; margin-left:6px; border:1px solid rgba(255,255,255,.12);}
    
    #inventory {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.85);
      border: 2px solid #555;
      border-radius: 8px;
      padding: 20px;
      display: none;
      z-index: 1000;
      backdrop-filter: blur(4px);
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }
    #inventory.visible {
      display: block;
    }
    .inventory-title {
      color: white;
      text-align: center;
      margin-bottom: 15px;
      font-size: 18px;
      font-weight: bold;
    }
    .inventory-grid {
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      gap: 8px;
      max-width: 500px;
    }
    .inventory-slot {
      width: 50px;
      height: 50px;
      background: rgba(100, 100, 100, 0.3);
      border: 1px solid #666;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }
    .inventory-slot:hover {
      background: rgba(150, 150, 150, 0.5);
      transform: scale(1.05);
    }
    .inventory-slot.selected {
      border: 2px solid #fff;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }
    .item-count {
      position: absolute;
      bottom: 2px;
      right: 4px;
      font-size: 12px;
      color: #fff;
    }
    .close-inventory {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ff4444;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 12px;
    }
    .close-inventory:hover {
      background: #ff6666;
    }
    
    #break-progress {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100px;
      height: 8px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 4px;
      display: none;
      z-index: 100;
    }
    #break-progress-bar {
      height: 100%;
      background: #ff5555;
      border-radius: 4px;
      width: 0%;
      transition: width 0.1s;
    }
    
    #debug-info {
      position: fixed;
      top: 16px;
      right: 16px;
      background: rgba(0,0,0,.55);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-family: monospace;
    }
    
    #multiplayer-info {
      position: fixed;
      top: 60px;
      right: 16px;
      background: rgba(0,0,0,.55);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-family: monospace;
    }
    
    .remote-player-label {
      position: absolute;
      background: rgba(0,0,0,.7);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      pointer-events: none;
      transform: translate(-50%, -30px);
      z-index: 10;
    }
    
    .health-bar {
      position: absolute;
      width: 40px;
      height: 5px;
      background: #444;
      border-radius: 2px;
      overflow: hidden;
      z-index: 10;
    }
    .health-fill {
      height: 100%;
      background: #ff5555;
      transition: width 0.3s;
    }
    
    #attack-mode-indicator {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 0, 0, 0.7);
      color: white;
      padding: 5px 15px;
      border-radius: 15px;
      font-size: 14px;
      display: none;
      z-index: 100;
    }
</style>
</head>
<body>
  <div id="ui">
    <div class="panel" id="help">
      <h1>Mini Minecraft (Çok Oyunculu) <span class="badge">128x128 Dünya</span></h1>
      <p><b>Bakınma:</b> fareyi <u>basılı tutup sürükle</u>.</p>
      <p><b>W A S D</b>: yürü — <b>Space</b>: zıpla — <b>Shift</b>: hızlı koş</p>
      <p><b>Sol tık basılı tut</b>: blok kır — <b>Sağ tık</b>: blok yerleştir</p>
      <p><b>1</b>: Çimen, <b>2</b>: Toprak, <b>3</b>: Taş, <b>4</b>: Tahta</p>
      <p><b>5</b>: Kömür, <b>6</b>: Demir, <b>7</b>: Altın, <b>8</b>: Elmas</p>
      <p><b>R</b>: rastgele ağaçlar — <b>G</b>: sis (fog) aç/kapat</p>
      <p><b>E</b>: envanteri aç/kapat</p>
      <p><b>Q</b>: Saldırı modu aç/kapat</p>
      <p style="opacity:.8">YENİ: Çok oyunculu destekli chunk sistemi!</p>
    </div>
    <div class="hotbar" id="hotbar"></div>
    <div class="crosshair"></div>
    <div class="hint">İpucu: Arkadaşlarınızla aynı dünyada oynayın!</div>
  </div>
  
  <div id="break-progress">
    <div id="break-progress-bar"></div>
  </div>
  
  <div id="debug-info">
    FPS: <span id="fps-counter">0</span> | 
    Chunks: <span id="chunk-counter">0</span> | 
    Blocks: <span id="block-counter">0</span>
  </div>
  
  <div id="multiplayer-info">
    Oyuncular: <span id="player-count">1</span> | 
    Durum: <span id="connection-status">Bağlantı Kuruluyor...</span>
  </div>
  
  <div id="inventory">
    <div class="inventory-title">Envanter</div>
    <button class="close-inventory" onclick="toggleInventory()">Kapat (E)</button>
    <div class="inventory-grid" id="inventoryGrid"></div>
  </div>
  
  <div id="attack-mode-indicator">SALDIRI MODU</div>

  <!-- Socket.io'yu doğrudan yükle -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  
  <script>
    // === Temel Ayarlar ===
    const WORLD_SIZE = 64;
    const WORLD_HEIGHT = 10;
    const CHUNK_SIZE = 16;
    const RENDER_DISTANCE = 1;
    const BLOCK = 1;
    let currentBlockType = 0;
    let playerId = 'player_' + Math.random().toString(36).substr(2, 9);
    
    // Saldırı modu
    let attackMode = false;
    const attackModeIndicator = document.getElementById('attack-mode-indicator');
    
    // Chunk hesaplama
    const CHUNKS_X = Math.ceil(WORLD_SIZE / CHUNK_SIZE);
    const CHUNKS_Z = Math.ceil(WORLD_SIZE / CHUNK_SIZE);
    
    // Geliştirilmiş blok tipleri
    const BLOCK_TYPES = [
      { key: 'grass', label: '1', colorTop: 0x6abf69, colorSide: 0x4d9b4b, breakTime: 0.8 },
      { key: 'dirt',  label: '2', colorTop: 0x8b5a2b, colorSide: 0x6f4620, breakTime: 0.6 },
      { key: 'stone', label: '3', colorTop: 0x9aa0a6, colorSide: 0x7a8086, breakTime: 1.5 },
      { key: 'wood',  label: '4', colorTop: 0xcaa472, colorSide: 0xa17f5b, breakTime: 1.0 },
      { key: 'coal',  label: '5', colorTop: 0x2d2d2d, colorSide: 0x1a1a1a, breakTime: 2.0 },
      { key: 'iron',  label: '6', colorTop: 0xd8d8d8, colorSide: 0xb0b0b0, breakTime: 2.5 },
      { key: 'gold',  label: '7', colorTop: 0xffd700, colorSide: 0xe6c200, breakTime: 2.0 },
      { key: 'diamond',label: '8',colorTop: 0x00ffff, colorSide: 0x00cccc, breakTime: 3.0 },
    ];

    // Hotbar UI
    const hotbar = document.getElementById('hotbar');
    BLOCK_TYPES.forEach((t, i) => {
      const el = document.createElement('div');
      el.className = 'slot' + (i === currentBlockType ? ' active' : '');
      el.textContent = t.label;
      el.dataset.index = i;
      hotbar.appendChild(el);
    });
    const updateHotbar = () => { [...hotbar.children].forEach((c, i) => c.classList.toggle('active', i === currentBlockType)); };

    // === THREE.js Kurulum ===
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb);
    scene.fog = new THREE.Fog(0x87ceeb, 20, 60);
    
    const camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 100);
    const player = new THREE.Object3D();
    player.position.set(WORLD_SIZE / 2, 5, WORLD_SIZE / 2);
    camera.position.set(0, 1.6, 0);
    player.add(camera);
    scene.add(player);

    const renderer = new THREE.WebGLRenderer({ antialias: false });
    renderer.setPixelRatio(1);
    renderer.setSize(innerWidth, innerHeight);
    renderer.shadowMap.enabled = false;
    document.body.appendChild(renderer.domElement);

    // Işıklar
    const ambient = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambient);
    const dir = new THREE.DirectionalLight(0xffffff, 0.8);
    dir.position.set(40, 60, 20);
    scene.add(dir);

    // Hedef bloğu vurgulamak için mesh
    const highlightGeo = new THREE.BoxGeometry(1.002, 1.002, 1.002);
    const highlightMat = new THREE.MeshBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.25, depthWrite: false });
    const highlightMesh = new THREE.Mesh(highlightGeo, highlightMat);
    scene.add(highlightMesh);

    // === Kılıç Modeli ===
    const swordGeometry = new THREE.BoxGeometry(0.1, 1, 0.1);
    const swordMaterial = new THREE.MeshLambertMaterial({ color: 0xc0c0c0 });
    const swordMesh = new THREE.Mesh(swordGeometry, swordMaterial);
    swordMesh.position.set(0.3, -0.5, -0.5);
    swordMesh.rotation.x = Math.PI / 2;
    swordMesh.visible = false;
    camera.add(swordMesh);

    // === Çok Oyunculu Sistem (Düzeltilmiş) ===
    let socket = null;
    const remotePlayers = new Map();
    let lastPositionSend = 0;
    let connectionRetryTimeout = null;

    // Socket.io bağlantısı - düzeltilmiş versiyon
    function connectToServer() {
      try {
        // Socket.io global değişken olarak mevcut olup olmadığını kontrol et
        if (typeof io === 'undefined') {
          console.log('Socket.io yüklenemedi, tek oyunculu modda devam ediliyor');
          document.getElementById('connection-status').textContent = 'Tek Oyunculu (Socket.io Yok)';
          return;
        }

        // Test sunucusu - gerçek sunucu adresi gerekli
        socket = io('https://aimc-25.onrender.com', {
          transports: ['websocket', 'polling'],
          timeout: 5000,
          forceNew: true
        });

        socket.on('connect', () => {
          document.getElementById('connection-status').textContent = 'Bağlandı';
          console.log('Sunucuya bağlandı:', socket.id);
          
          // Sunucuya katılma mesajı gönder
          socket.emit('join', {
            id: playerId,
            username: 'Oyuncu' + Math.floor(Math.random() * 1000),
            x: player.position.x,
            y: player.position.y,
            z: player.position.z,
            yaw: yaw,
            pitch: pitch,
            attackMode: attackMode
          });
        });

        socket.on('disconnect', (reason) => {
          document.getElementById('connection-status').textContent = 'Bağlantı Kesildi';
          console.log('Sunucu bağlantısı kesildi:', reason);
          
          // Otomatik yeniden bağlanma
          if (reason !== 'io client disconnect') {
            connectionRetryTimeout = setTimeout(() => {
              console.log('Yeniden bağlanmaya çalışıyor...');
              connectToServer();
            }, 3000);
          }
        });

        socket.on('connect_error', (error) => {
          document.getElementById('connection-status').textContent = 'Bağlantı Hatası';
          console.log('Bağlantı hatası:', error.message);
          
          // Yeniden bağlanma denemesi
          connectionRetryTimeout = setTimeout(() => {
            console.log('Yeniden bağlanmaya çalışıyor...');
            connectToServer();
          }, 5000);
        });

        // Diğer oyuncuların katılma mesajı
        socket.on('playerJoined', (playerData) => {
          console.log('Yeni oyuncu katıldı:', playerData);
          if (playerData.id !== playerId) {
            addRemotePlayer(playerData);
          }
          updatePlayerCount();
        });

        // Diğer oyuncuların hareketi - düzeltilmiş
        socket.on('playerMoved', (playerData) => {
          if (playerData.id !== playerId) {
            updateRemotePlayer(playerData);
          }
        });

        // Mevcut oyuncular listesi
        socket.on('currentPlayers', (players) => {
          console.log('Mevcut oyuncular alındı:', players);
          Object.values(players).forEach(playerData => {
            if (playerData.id !== playerId) {
              addRemotePlayer(playerData);
            }
          });
          updatePlayerCount();
        });

        // Oyuncu ayrıldığında
        socket.on('playerLeft', (playerData) => {
          console.log('Oyuncu ayrıldı:', playerData);
          removeRemotePlayer(playerData.id);
          updatePlayerCount();
        });

        // Blok güncelleme
        socket.on('blockUpdate', (blockData) => {
          console.log('Blok güncellemesi:', blockData);
          if (blockData.action === 'remove') {
            removeBlock(blockData.x, blockData.y, blockData.z, true);
          } else if (blockData.action === 'add') {
            addBlock(blockData.x, blockData.y, blockData.z, blockData.type, true);
          }
        });

        // Dünya durumu
        socket.on('worldState', (worldData) => {
          console.log('Dünya durumu alındı:', worldData);
          if (worldData.blocks) {
            worldData.blocks.forEach(blockData => {
              addBlock(blockData.x, blockData.y, blockData.z, blockData.type, true);
            });
          }
        });

        // Saldırı olayı
        socket.on('playerAttacked', (attackData) => {
          console.log('Saldırı alındı:', attackData);
        });

        // Can güncelleme olayı
        socket.on('playerHealthUpdated', (healthData) => {
          if (healthData.id !== playerId) {
            const remotePlayer = remotePlayers.get(healthData.id);
            if (remotePlayer) {
              remotePlayer.health = healthData.health;
              updateHealthBar(remotePlayer);
            }
          }
        });

      } catch (error) {
        console.log('Socket.io başlatılamadı:', error);
        document.getElementById('connection-status').textContent = 'Tek Oyunculu (Hata)';
      }
    }

    // Pozisyon gönderimi - throttle ile optimize edilmiş
    function sendPlayerPosition() {
      if (socket && socket.connected) {
        const now = Date.now();
        if (now - lastPositionSend > 50) { // 50ms'de bir gönder (20 FPS)
          socket.emit('move', {
            id: playerId,
            x: Math.round(player.position.x * 100) / 100, // Precision reduce
            y: Math.round(player.position.y * 100) / 100,
            z: Math.round(player.position.z * 100) / 100,
            yaw: Math.round(yaw * 100) / 100,
            pitch: Math.round(pitch * 100) / 100,
            attackMode: attackMode
          });
          lastPositionSend = now;
        }
      }
    }

    // Blok değişikliği gönderimi
    function sendBlockChange(x, y, z, action, type) {
      if (socket && socket.connected) {
        socket.emit('blockAction', {
          x, y, z, action, type,
          playerId: playerId
        });
      }
    }

    // Saldırı gönderimi
    function sendAttack() {
      if (socket && socket.connected && attackMode) {
        const attackData = {
          attackerId: playerId,
          targetIds: [],
          timestamp: Date.now()
        };
        
        // Yakındaki tüm uzak oyuncuları bul
        remotePlayers.forEach((remotePlayer, id) => {
          const distance = player.position.distanceTo(remotePlayer.group.position);
          if (distance < 3) {
            attackData.targetIds.push(id);
          }
        });

        if (attackData.targetIds.length > 0) {
          socket.emit('attack', attackData);
          console.log('Saldırı gönderildi:', attackData);
        }
      }
    }

    // Can sistemini başlat
    let playerHealth = 100;
    const maxHealth = 100;

    // Can bar'ı oluşturma fonksiyonu
    function createHealthBar() {
      const healthBar = document.createElement('div');
      healthBar.className = 'health-bar';
      healthBar.innerHTML = '<div class="health-fill"></div>';
      healthBar.style.display = 'none';
      document.body.appendChild(healthBar);
      return healthBar;
    }

    // Uzak oyuncular - düzeltilmiş versiyon
    function addRemotePlayer(playerData) {
      console.log('Uzak oyuncu ekleniyor:', playerData);
      
      // Zaten var mı kontrol et
      if (remotePlayers.has(playerData.id)) {
        console.log('Oyuncu zaten mevcut:', playerData.id);
        return;
      }

      // Oyuncu modeli için bir grup oluştur
      const playerGroup = new THREE.Group();
      
      // Gövde
      const bodyGeometry = new THREE.BoxGeometry(0.6, 0.9, 0.3);
      const bodyMaterial = new THREE.MeshLambertMaterial({ 
        color: playerData.attackMode ? 0xff0000 : 0x0000ff 
      });
      const bodyMesh = new THREE.Mesh(bodyGeometry, bodyMaterial);
      bodyMesh.position.y = 0.45;
      playerGroup.add(bodyMesh);
      
      // Kafa
      const headGeometry = new THREE.BoxGeometry(0.4, 0.4, 0.4);
      const headMaterial = new THREE.MeshLambertMaterial({ color: 0xffcc99 });
      const headMesh = new THREE.Mesh(headGeometry, headMaterial);
      headMesh.position.y = 1.1;
      playerGroup.add(headMesh);
      
      // Kollar
      const armGeometry = new THREE.BoxGeometry(0.15, 0.7, 0.15);
      const armMaterial = new THREE.MeshLambertMaterial({ color: 0x000088 });
      const leftArmMesh = new THREE.Mesh(armGeometry, armMaterial);
      leftArmMesh.position.set(-0.4, 0.45, 0);
      playerGroup.add(leftArmMesh);
      const rightArmMesh = new THREE.Mesh(armGeometry, armMaterial);
      rightArmMesh.position.set(0.4, 0.45, 0);
      playerGroup.add(rightArmMesh);
      
      // Ayaklar
      const legGeometry = new THREE.BoxGeometry(0.2, 0.8, 0.2);
      const legMaterial = new THREE.MeshLambertMaterial({ color: 0x000088 });
      const leftLegMesh = new THREE.Mesh(legGeometry, legMaterial);
      leftLegMesh.position.set(-0.15, -0.4, 0);
      playerGroup.add(leftLegMesh);
      const rightLegMesh = new THREE.Mesh(legGeometry, legMaterial);
      rightLegMesh.position.set(0.15, -0.4, 0);
      playerGroup.add(rightLegMesh);
      
      // Pozisyonu ayarla
      playerGroup.position.set(playerData.x || 0, playerData.y || 5, playerData.z || 0);
      
      // Yön ayarla
      if (playerData.yaw !== undefined) {
        playerGroup.rotation.y = playerData.yaw;
      }
      
      // Sahneye ekle
      scene.add(playerGroup);
      
      // Oyuncu adı etiketi
      const label = document.createElement('div');
      label.className = 'remote-player-label';
      label.textContent = playerData.username || 'Oyuncu';
      document.body.appendChild(label);
      
      // Can bar'ı oluştur
      const healthBar = createHealthBar();
      
      // Oyuncuyu haritaya ekle
      remotePlayers.set(playerData.id, {
        group: playerGroup,
        label: label,
        healthBar: healthBar,
        playerData: playerData, // Düzeltildi: 'data' yerine 'playerData'
        health: playerData.health || maxHealth,
        bodyMesh: bodyMesh // Renk değişimi için referans
      });

      console.log('Uzak oyuncu eklendi:', playerData.id);
    }

    // updateRemotePlayer fonksiyonu - düzeltilmiş
    function updateRemotePlayer(playerData) {
      const remotePlayer = remotePlayers.get(playerData.id);
      if (!remotePlayer) {
        console.log('Uzak oyuncu bulunamadı, ekleniyor:', playerData.id);
        addRemotePlayer(playerData);
        return;
      }

      // Pozisyonu güncelle
      remotePlayer.group.position.set(
        playerData.x || remotePlayer.group.position.x, 
        playerData.y || remotePlayer.group.position.y, 
        playerData.z || remotePlayer.group.position.z
      );
      
      // Yönü güncelle
      if (playerData.yaw !== undefined) {
        remotePlayer.group.rotation.y = playerData.yaw;
      }
      
      // Saldırı moduna göre rengi güncelle
      if (playerData.attackMode !== undefined) {
        remotePlayer.bodyMesh.material.color.setHex(playerData.attackMode ? 0xff0000 : 0x0000ff);
      }
